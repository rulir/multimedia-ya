"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),App=function(){function e(t){_classCallCheck(this,e),this.appEl=t,this.form=this.appEl.querySelector(".source-links-form"),this.form.addEventListener("submit",this._onSourceLinksFormSubmit.bind(this))}return _createClass(e,[{key:"_onSourceLinksFormSubmit",value:function(e){e.preventDefault(),this.urlMap={videoUrl:this.appEl.querySelector("#videoUrl").value,subsUrl:this.appEl.querySelector("#subUrl").value,audioUrl:this.appEl.querySelector("#audioUrl").value},this.appEl.querySelector(".initial-page").classList.add("initial-page_hidden"),this.appEl.querySelector(".video-page").classList.remove("video-page_hidden"),this.canvas=new Canvas(this.appEl.querySelector(".canvas")),this.subs=new Subs(this.urlMap),this.player=new Player(this.appEl.querySelector(".video"),this.urlMap,this.canvas,this.subs)}}]),e}(),Player=function(){function e(t,s,i,a){_classCallCheck(this,e),this.playerEl=t,this.videoUrl=s.videoUrl,this.subsUrl=s.subsUrl,this.canvas=i,this.subs=a,this.subsCurrСue=0,this.videoSourceEl=document.createElement("source"),this.videoSourceEl.setAttribute("src",this.videoUrl),this.playerEl.appendChild(this.videoSourceEl),this.playerEl.addEventListener("play",this._onVideoStartToPlay.bind(this)),this.playerEl.addEventListener("seeking",this._onVideoSeeking.bind(this))}return _createClass(e,[{key:"_onVideoStartToPlay",value:function(e){this.checkSubsAvailability(e)!==!1&&(this.setCanvasSizesToVideoSizes(),this.startTimeСountup(),this.watchTheVideo())}},{key:"_onVideoSeeking",value:function(e){filterParsedSubs()}},{key:"checkSubsAvailability",value:function(e){if(!this.subs.ready)return e.preventDefault(),this.playerEl.pause(),this.playerEl.currentTime=0,!1}},{key:"setCanvasSizesToVideoSizes",value:function(){this.videoWidth=this.playerEl.clientWidth,this.videoHeight=this.playerEl.clientHeight,this.canvas.canvasEl.width=this.videoWidth,this.canvas.canvasEl.height=this.videoHeight}},{key:"getNeededSubsForThisTime",value:function(){var e=parseInt(1e3*this.playerEl.currentTime),t=this.subs.parsedSubs.filter(function(t){if(t.endTime>=e)return!0});return t}},{key:"filterParsedSubs",value:function(){var e=this;t&&clearTimeout(t);var t=setTimeout(function(){e.subs.parsedSubs=e.getNeededSubsForThisTime()},10)}},{key:"startTimeСountup",value:function(){var e=this,t=this.subs.parsedSubs[this.subsCurrСue].endTime-parseInt(this.playerEl.currentTime),s=this.subs.parsedSubs[this.subsCurrСue].endTime-this.subs.parsedSubs[this.subsCurrСue].startTime;console.log(t,s);var i=setTimeout(function(){e.playerEl.pause(),clearTimeout(i);var a=setTimeout(function(){e.playerEl.play(),e.subsCurrСue++,t=e.subs.parsedSubs[e.subsCurrСue].endTime-parseInt(e.playerEl.currentTime),s=e.subs.parsedSubs[e.subsCurrСue].endTime-e.subs.parsedSubs[e.subsCurrСue].startTime,clearTimeout(a)},s)},t)}},{key:"watchTheVideo",value:function(){var e=this;this.playerEl.paused||this.playerEl.ended||(this.paintFrame(),setTimeout(function(){e.watchTheVideo()},0))}},{key:"paintFrame",value:function(){this.canvas.context.drawImage(this.playerEl,0,0,this.videoWidth,this.videoHeight);for(var e=this.canvas.context.getImageData(0,0,this.videoWidth,this.videoHeight),t=e.data.length/4,s=0;s<t;s++){var i=e.data[4*s+0],a=e.data[4*s+1],r=e.data[4*s+2],u=.21*i+.72*a+.07*r;e.data[4*s+0]=u,e.data[4*s+1]=u,e.data[4*s+2]=u}this.canvas.context.putImageData(e,0,0)}}]),e}(),Canvas=function e(t){_classCallCheck(this,e),this.canvasEl=t,this.context=this.canvasEl.getContext("2d")},Subs=function(){function e(t){var s=this;_classCallCheck(this,e),this.ready=!1,fetch(t.subsUrl).then(function(e){e.text().then(function(e){s.parsedSubs=s.parseFromSrt(e),s.ready=!0})})}return _createClass(e,[{key:"parseFromSrt",value:function(e){function t(e,t){var s=t[e].split(":"),i=s[0],a=Number(s[1]),r=s[2].split(","),u=Number(r[0]),n=Number(r[1]);t[e]=36e5*i+6e4*a+1e3*u+n}var s=parser.fromSrt(e);return s.map(function(e){t("endTime",e),t("startTime",e)}),s}}]),e}(),app=new App(document.querySelector(".app"));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImJ1bmRsZS5qcyJdLCJuYW1lcyI6WyJfY2xhc3NDYWxsQ2hlY2siLCJpbnN0YW5jZSIsIkNvbnN0cnVjdG9yIiwiVHlwZUVycm9yIiwiX2NyZWF0ZUNsYXNzIiwiZGVmaW5lUHJvcGVydGllcyIsInRhcmdldCIsInByb3BzIiwiaSIsImxlbmd0aCIsImRlc2NyaXB0b3IiLCJlbnVtZXJhYmxlIiwiY29uZmlndXJhYmxlIiwid3JpdGFibGUiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImtleSIsInByb3RvUHJvcHMiLCJzdGF0aWNQcm9wcyIsInByb3RvdHlwZSIsIkFwcCIsImVsIiwidGhpcyIsImFwcEVsIiwiZm9ybSIsInF1ZXJ5U2VsZWN0b3IiLCJhZGRFdmVudExpc3RlbmVyIiwiX29uU291cmNlTGlua3NGb3JtU3VibWl0IiwiYmluZCIsInZhbHVlIiwiZSIsInByZXZlbnREZWZhdWx0IiwidXJsTWFwIiwidmlkZW9VcmwiLCJzdWJzVXJsIiwiYXVkaW9VcmwiLCJjbGFzc0xpc3QiLCJhZGQiLCJyZW1vdmUiLCJjYW52YXMiLCJDYW52YXMiLCJzdWJzIiwiU3VicyIsInBsYXllciIsIlBsYXllciIsInBsYXllckVsIiwic3Vic0N1cnLQoXVlIiwidmlkZW9Tb3VyY2VFbCIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsInNldEF0dHJpYnV0ZSIsImFwcGVuZENoaWxkIiwiX29uVmlkZW9TdGFydFRvUGxheSIsIl9vblZpZGVvU2Vla2luZyIsImNoZWNrU3Vic0F2YWlsYWJpbGl0eSIsInNldENhbnZhc1NpemVzVG9WaWRlb1NpemVzIiwic3RhcnRUaW1l0KFvdW50dXAiLCJ3YXRjaFRoZVZpZGVvIiwiZmlsdGVyUGFyc2VkU3VicyIsInJlYWR5IiwicGF1c2UiLCJjdXJyZW50VGltZSIsInZpZGVvV2lkdGgiLCJjbGllbnRXaWR0aCIsInZpZGVvSGVpZ2h0IiwiY2xpZW50SGVpZ2h0IiwiY2FudmFzRWwiLCJ3aWR0aCIsImhlaWdodCIsInBhcnNlSW50IiwiZmlsdGVyZWRTdWJzIiwicGFyc2VkU3VicyIsImZpbHRlciIsIml0ZW0iLCJlbmRUaW1lIiwiX3RoaXMiLCJ0byIsImNsZWFyVGltZW91dCIsInNldFRpbWVvdXQiLCJnZXROZWVkZWRTdWJzRm9yVGhpc1RpbWUiLCJfdGhpczIiLCJtYXJnaW5Ub1N0YXJ0T2ZTdWJzIiwibmVhcmVzdFBhdXNlRHVyYXRpb24iLCJzdGFydFRpbWUiLCJjb25zb2xlIiwibG9nIiwidDEiLCJ0MiIsInBsYXkiLCJfdGhpczMiLCJwYXVzZWQiLCJlbmRlZCIsInBhaW50RnJhbWUiLCJjb250ZXh0IiwiZHJhd0ltYWdlIiwiZnJhbWUiLCJnZXRJbWFnZURhdGEiLCJkYXRhIiwiciIsImciLCJiIiwiYXZlcmFnZSIsInB1dEltYWdlRGF0YSIsImdldENvbnRleHQiLCJfdGhpczQiLCJmZXRjaCIsInRoZW4iLCJyZXMiLCJ0ZXh0IiwicGFyc2VGcm9tU3J0Iiwic3J0IiwidGltZVBhcnNlVG9NcyIsInRpbWVUeXBlIiwic3Vic1N0YXJ0VGltZUJ1ZmZlciIsInNwbGl0IiwiaG91cnMiLCJtaW5zIiwiTnVtYmVyIiwic2Vjc0FuZE1zZWNzQnVmZmVyIiwic2VjcyIsIm1zZWNzIiwicGFyc2VyIiwiZnJvbVNydCIsIm1hcCIsImFwcCJdLCJtYXBwaW5ncyI6IkFBQUEsWUNJQSxTQUFTQSxpQkFBZ0JDLEVBQVVDLEdBQWUsS0FBTUQsWUFBb0JDLElBQWdCLEtBQU0sSUFBSUMsV0FBVSxxQ0FGaEgsR0FBSUMsY0FBZSxXQUFjLFFBQVNDLEdBQWlCQyxFQUFRQyxHQUFTLElBQUssR0FBSUMsR0FBSSxFQUFHQSxFQUFJRCxFQUFNRSxPQUFRRCxJQUFLLENBQUUsR0FBSUUsR0FBYUgsRUFBTUMsRUFBSUUsR0FBV0MsV0FBYUQsRUFBV0MsYUFBYyxFQUFPRCxFQUFXRSxjQUFlLEVBQVUsU0FBV0YsS0FBWUEsRUFBV0csVUFBVyxHQUFNQyxPQUFPQyxlQUFlVCxFQUFRSSxFQUFXTSxJQUFLTixJQUFpQixN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QU9DLE9BQU9KLEVBQW9CLElBQ2xDSyxFQUFxQkwsRUFBb0IsR0FBR0MsTUFBTSxLQUNsREssRUFBT0YsT0FBT0MsRUFBbUIsSUFDakNFLEVBQVFILE9BQU9DLEVBQW1CLEdBQ3RDN0MsR0FBS3VDLEdBQW9CLEtBQVJHLEVBQXlCLElBQVBDLEVBQXNCLElBQVBHLEVBQWNDLEVBZGpFLEdBQUlqRCxHQUFha0QsT0FBT0MsUUFBUVosRUFnQmhDLE9BZEF2QyxHQUFXb0QsSUFBSSxTQUFBbEQsR0FDZHNDLEVBQWMsVUFBV3RDLEdBQ3pCc0MsRUFBYyxZQUFhdEMsS0FZckJGLE1DNENEN0IsS0R4Q0ZrRixJQUFNLEdBQUl4RyxLQUFJNEIsU0FBU3ZCLGNBQWMiLCJmaWxlIjoiYnVuZGxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmNsYXNzIEFwcCB7XG5cdGNvbnN0cnVjdG9yKGVsKSB7XG5cdFx0dGhpcy5hcHBFbCA9IGVsO1xuXHRcdHRoaXMuZm9ybSA9IHRoaXMuYXBwRWwucXVlcnlTZWxlY3RvcignLnNvdXJjZS1saW5rcy1mb3JtJyk7XG5cdFx0dGhpcy5mb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIHRoaXMuX29uU291cmNlTGlua3NGb3JtU3VibWl0LmJpbmQodGhpcykpO1xuXHR9O1xuXG5cdF9vblNvdXJjZUxpbmtzRm9ybVN1Ym1pdChlKSB7XG5cdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdHRoaXMudXJsTWFwID0ge1xuXHRcdFx0dmlkZW9Vcmw6IHRoaXMuYXBwRWwucXVlcnlTZWxlY3RvcignI3ZpZGVvVXJsJykudmFsdWUsXG5cdFx0XHRzdWJzVXJsOiB0aGlzLmFwcEVsLnF1ZXJ5U2VsZWN0b3IoJyNzdWJVcmwnKS52YWx1ZSxcblx0XHRcdGF1ZGlvVXJsOiB0aGlzLmFwcEVsLnF1ZXJ5U2VsZWN0b3IoJyNhdWRpb1VybCcpLnZhbHVlLFxuXHRcdH07XG5cdFx0dGhpcy5hcHBFbC5xdWVyeVNlbGVjdG9yKCcuaW5pdGlhbC1wYWdlJykuY2xhc3NMaXN0LmFkZCgnaW5pdGlhbC1wYWdlX2hpZGRlbicpO1xuXHRcdHRoaXMuYXBwRWwucXVlcnlTZWxlY3RvcignLnZpZGVvLXBhZ2UnKS5jbGFzc0xpc3QucmVtb3ZlKCd2aWRlby1wYWdlX2hpZGRlbicpO1xuXG5cdFx0dGhpcy5jYW52YXMgPSBuZXcgQ2FudmFzKHRoaXMuYXBwRWwucXVlcnlTZWxlY3RvcignLmNhbnZhcycpKTtcblx0XHR0aGlzLnN1YnMgPSBuZXcgU3Vicyh0aGlzLnVybE1hcCk7XG5cdFx0dGhpcy5wbGF5ZXIgPSBuZXcgUGxheWVyKHRoaXMuYXBwRWwucXVlcnlTZWxlY3RvcignLnZpZGVvJyksIHRoaXMudXJsTWFwLCB0aGlzLmNhbnZhcywgdGhpcy5zdWJzKTtcblx0fTtcbn07XG5cbmNsYXNzIFBsYXllciB7XG5cdGNvbnN0cnVjdG9yKGVsLCB1cmxNYXAsIGNhbnZhcywgc3Vicykge1xuXHRcdHRoaXMucGxheWVyRWwgPSBlbDtcblx0XHR0aGlzLnZpZGVvVXJsID0gdXJsTWFwLnZpZGVvVXJsO1xuXHRcdHRoaXMuc3Vic1VybCA9IHVybE1hcC5zdWJzVXJsO1xuXHRcdHRoaXMuY2FudmFzID0gY2FudmFzO1xuXHRcdHRoaXMuc3VicyA9IHN1YnM7XG5cdFx0dGhpcy5zdWJzQ3VyctChdWUgPSAwO1xuXHRcdHRoaXMudmlkZW9Tb3VyY2VFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NvdXJjZScpO1xuXHRcdHRoaXMudmlkZW9Tb3VyY2VFbC5zZXRBdHRyaWJ1dGUoJ3NyYycsIHRoaXMudmlkZW9VcmwpO1xuXHRcdHRoaXMucGxheWVyRWwuYXBwZW5kQ2hpbGQodGhpcy52aWRlb1NvdXJjZUVsKTtcblx0XHR0aGlzLnBsYXllckVsLmFkZEV2ZW50TGlzdGVuZXIoJ3BsYXknLCB0aGlzLl9vblZpZGVvU3RhcnRUb1BsYXkuYmluZCh0aGlzKSk7XG5cdFx0dGhpcy5wbGF5ZXJFbC5hZGRFdmVudExpc3RlbmVyKCdzZWVraW5nJywgdGhpcy5fb25WaWRlb1NlZWtpbmcuYmluZCh0aGlzKSk7XG5cdH07XG5cblx0X29uVmlkZW9TdGFydFRvUGxheShlKSB7XG5cdFx0aWYgKHRoaXMuY2hlY2tTdWJzQXZhaWxhYmlsaXR5KGUpID09PSBmYWxzZSkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH07XG5cdFx0dGhpcy5zZXRDYW52YXNTaXplc1RvVmlkZW9TaXplcygpO1xuXHRcdHRoaXMuc3RhcnRUaW1l0KFvdW50dXAoKTtcblx0XHR0aGlzLndhdGNoVGhlVmlkZW8oKTtcblx0fTtcblxuXHRfb25WaWRlb1NlZWtpbmcoZSkge1xuXHRcdGZpbHRlclBhcnNlZFN1YnMoKTtcblx0fTtcblxuXHRjaGVja1N1YnNBdmFpbGFiaWxpdHkoZSkge1xuXHRcdGlmICghdGhpcy5zdWJzLnJlYWR5KSB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHR0aGlzLnBsYXllckVsLnBhdXNlKCk7XG5cdFx0XHR0aGlzLnBsYXllckVsLmN1cnJlbnRUaW1lID0gMDtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9O1xuXHR9O1xuXG5cdHNldENhbnZhc1NpemVzVG9WaWRlb1NpemVzKCkge1xuXHRcdHRoaXMudmlkZW9XaWR0aCA9IHRoaXMucGxheWVyRWwuY2xpZW50V2lkdGg7XG5cdFx0dGhpcy52aWRlb0hlaWdodCA9IHRoaXMucGxheWVyRWwuY2xpZW50SGVpZ2h0O1xuXHRcdHRoaXMuY2FudmFzLmNhbnZhc0VsLndpZHRoID0gdGhpcy52aWRlb1dpZHRoO1xuXHRcdHRoaXMuY2FudmFzLmNhbnZhc0VsLmhlaWdodCA9IHRoaXMudmlkZW9IZWlnaHQ7XG5cdH07XG5cblx0Z2V0TmVlZGVkU3Vic0ZvclRoaXNUaW1lKCkge1xuXHRcdGxldCBjdXJyZW50VGltZSA9IHBhcnNlSW50KHRoaXMucGxheWVyRWwuY3VycmVudFRpbWUgKiAxMDAwKTtcblx0XHRsZXQgZmlsdGVyZWRTdWJzID0gdGhpcy5zdWJzLnBhcnNlZFN1YnMuZmlsdGVyKGl0ZW0gPT4ge1xuXHRcdFx0aWYgKGl0ZW0uZW5kVGltZSA+PSBjdXJyZW50VGltZSkge1xuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdH07XG5cdFx0fSk7XG5cdFx0cmV0dXJuIGZpbHRlcmVkU3Vicztcblx0fTtcblxuXHRmaWx0ZXJQYXJzZWRTdWJzKCkge1xuXHRcdGlmICh0bykge1xuXHRcdFx0Y2xlYXJUaW1lb3V0KHRvKTtcblx0XHR9O1xuXHRcdGxldCB0byA9IHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0dGhpcy5zdWJzLnBhcnNlZFN1YnMgPSB0aGlzLmdldE5lZWRlZFN1YnNGb3JUaGlzVGltZSgpO1xuXHRcdH0sIDEwKTtcblxuXHR9O1xuXG5cdHN0YXJ0VGltZdChb3VudHVwKCkge1xuXHRcdFxuXHRcdGxldCBtYXJnaW5Ub1N0YXJ0T2ZTdWJzID0gdGhpcy5zdWJzLnBhcnNlZFN1YnNbdGhpcy5zdWJzQ3VyctChdWVdLmVuZFRpbWUgLSBwYXJzZUludCh0aGlzLnBsYXllckVsLmN1cnJlbnRUaW1lKTtcblx0XHRsZXQgbmVhcmVzdFBhdXNlRHVyYXRpb24gPSB0aGlzLnN1YnMucGFyc2VkU3Vic1t0aGlzLnN1YnNDdXJy0KF1ZV0uZW5kVGltZSAtIHRoaXMuc3Vicy5wYXJzZWRTdWJzW3RoaXMuc3Vic0N1cnLQoXVlXS5zdGFydFRpbWU7XG5cblx0XHRjb25zb2xlLmxvZyhtYXJnaW5Ub1N0YXJ0T2ZTdWJzLCBuZWFyZXN0UGF1c2VEdXJhdGlvbik7XG5cblx0XHRsZXQgdDEgPSBzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdHRoaXMucGxheWVyRWwucGF1c2UoKTtcblx0XHRcdGNsZWFyVGltZW91dCh0MSk7XG5cdFx0XHRsZXQgdDIgPSBzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdFx0dGhpcy5wbGF5ZXJFbC5wbGF5KCk7XG5cdFx0XHRcdHRoaXMuc3Vic0N1cnLQoXVlKys7XG5cdFx0XHRcdG1hcmdpblRvU3RhcnRPZlN1YnMgPSB0aGlzLnN1YnMucGFyc2VkU3Vic1t0aGlzLnN1YnNDdXJy0KF1ZV0uZW5kVGltZSAtIHBhcnNlSW50KHRoaXMucGxheWVyRWwuY3VycmVudFRpbWUpO1xuXHRcdFx0XHRuZWFyZXN0UGF1c2VEdXJhdGlvbiA9IHRoaXMuc3Vicy5wYXJzZWRTdWJzW3RoaXMuc3Vic0N1cnLQoXVlXS5lbmRUaW1lIC0gdGhpcy5zdWJzLnBhcnNlZFN1YnNbdGhpcy5zdWJzQ3VyctChdWVdLnN0YXJ0VGltZTtcblx0XHRcdFx0Y2xlYXJUaW1lb3V0KHQyKTtcblx0XHRcdH0sIG5lYXJlc3RQYXVzZUR1cmF0aW9uKTtcblx0XHR9LCBtYXJnaW5Ub1N0YXJ0T2ZTdWJzKTtcblx0fTtcblxuXHR3YXRjaFRoZVZpZGVvKCkge1xuXHRcdGlmICh0aGlzLnBsYXllckVsLnBhdXNlZCB8fCB0aGlzLnBsYXllckVsLmVuZGVkKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fTtcblxuXHRcdHRoaXMucGFpbnRGcmFtZSgpO1xuXG5cdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHR0aGlzLndhdGNoVGhlVmlkZW8oKTtcblx0XHR9LCAwKTtcblx0fTtcblxuXHRwYWludEZyYW1lKCkge1xuXHRcdHRoaXMuY2FudmFzLmNvbnRleHQuZHJhd0ltYWdlKHRoaXMucGxheWVyRWwsIDAsIDAsIHRoaXMudmlkZW9XaWR0aCwgdGhpcy52aWRlb0hlaWdodCk7XG5cdFx0bGV0IGZyYW1lID0gdGhpcy5jYW52YXMuY29udGV4dC5nZXRJbWFnZURhdGEoMCwgMCwgdGhpcy52aWRlb1dpZHRoLCB0aGlzLnZpZGVvSGVpZ2h0KTtcblx0XHRsZXQgbGVuZ3RoID0gZnJhbWUuZGF0YS5sZW5ndGggLyA0O1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuXHRcdFx0bGV0IHIgPSBmcmFtZS5kYXRhW2kgKiA0ICsgMF07XG5cdFx0XHRsZXQgZyA9IGZyYW1lLmRhdGFbaSAqIDQgKyAxXTtcblx0XHRcdGxldCBiID0gZnJhbWUuZGF0YVtpICogNCArIDJdO1xuXHRcdFx0bGV0IGF2ZXJhZ2UgPSAwLjIxICogciArIDAuNzIgKiBnICsgMC4wNyAqIGI7XG5cdFx0XHRmcmFtZS5kYXRhW2kgKiA0ICsgMF0gPSBhdmVyYWdlO1xuXHRcdFx0ZnJhbWUuZGF0YVtpICogNCArIDFdID0gYXZlcmFnZTtcblx0XHRcdGZyYW1lLmRhdGFbaSAqIDQgKyAyXSA9IGF2ZXJhZ2U7XG5cdFx0fTtcblxuXHRcdHRoaXMuY2FudmFzLmNvbnRleHQucHV0SW1hZ2VEYXRhKGZyYW1lLCAwLCAwKTtcblx0fTtcbn07XG5cbmNsYXNzIENhbnZhcyB7XG5cdGNvbnN0cnVjdG9yKGVsKSB7XG5cdFx0dGhpcy5jYW52YXNFbCA9IGVsO1xuXHRcdHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzRWwuZ2V0Q29udGV4dChcIjJkXCIpO1xuXHR9O1xufTtcblxuY2xhc3MgU3VicyB7XG5cdGNvbnN0cnVjdG9yKHVybE1hcCkge1xuXHRcdHRoaXMucmVhZHkgPSBmYWxzZTtcblx0XHRmZXRjaCh1cmxNYXAuc3Vic1VybClcblx0XHRcdC50aGVuKHJlcyA9PiB7XG5cdFx0XHRcdHJlcy50ZXh0KClcblx0XHRcdFx0XHQudGhlbihkYXRhID0+IHtcblx0XHRcdFx0XHRcdHRoaXMucGFyc2VkU3VicyA9IHRoaXMucGFyc2VGcm9tU3J0KGRhdGEpO1xuXHRcdFx0XHRcdFx0dGhpcy5yZWFkeSA9IHRydWU7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHR9KTtcblx0fTtcblxuXHRwYXJzZUZyb21TcnQoc3J0KSB7XG5cdFx0bGV0IHBhcnNlZFN1YnMgPSBwYXJzZXIuZnJvbVNydChzcnQpO1xuXG5cdFx0cGFyc2VkU3Vicy5tYXAoaXRlbSA9PiB7XG5cdFx0XHR0aW1lUGFyc2VUb01zKCdlbmRUaW1lJywgaXRlbSk7XG5cdFx0XHR0aW1lUGFyc2VUb01zKCdzdGFydFRpbWUnLCBpdGVtKTtcblx0XHR9KTtcblxuXHRcdGZ1bmN0aW9uIHRpbWVQYXJzZVRvTXModGltZVR5cGUsIGl0ZW0pIHtcblx0XHRcdGxldCBzdWJzU3RhcnRUaW1lQnVmZmVyID0gaXRlbVt0aW1lVHlwZV0uc3BsaXQoJzonKTtcblx0XHRcdGxldCBob3VycyA9IHN1YnNTdGFydFRpbWVCdWZmZXJbMF07XG5cdFx0XHRsZXQgbWlucyA9IE51bWJlcihzdWJzU3RhcnRUaW1lQnVmZmVyWzFdKTtcblx0XHRcdGxldCBzZWNzQW5kTXNlY3NCdWZmZXIgPSBzdWJzU3RhcnRUaW1lQnVmZmVyWzJdLnNwbGl0KCcsJyk7XG5cdFx0XHRsZXQgc2VjcyA9IE51bWJlcihzZWNzQW5kTXNlY3NCdWZmZXJbMF0pO1xuXHRcdFx0bGV0IG1zZWNzID0gTnVtYmVyKHNlY3NBbmRNc2Vjc0J1ZmZlclsxXSk7XG5cdFx0XHRpdGVtW3RpbWVUeXBlXSA9IGhvdXJzICogMzYwMDAwMCArIG1pbnMgKiA2MDAwMCArIHNlY3MgKiAxMDAwICsgbXNlY3M7XG5cdFx0fTtcblx0XHRyZXR1cm4gcGFyc2VkU3Vicztcblx0fTtcbn07XG5cbmNvbnN0IGFwcCA9IG5ldyBBcHAoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmFwcCcpKTsiLCJcInVzZSBzdHJpY3RcIjtcblxudmFyIF9jcmVhdGVDbGFzcyA9IGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmIChcInZhbHVlXCIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0oKTtcblxuZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKFwiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uXCIpOyB9IH1cblxudmFyIEFwcCA9IGZ1bmN0aW9uICgpIHtcblx0ZnVuY3Rpb24gQXBwKGVsKSB7XG5cdFx0X2NsYXNzQ2FsbENoZWNrKHRoaXMsIEFwcCk7XG5cblx0XHR0aGlzLmFwcEVsID0gZWw7XG5cdFx0dGhpcy5mb3JtID0gdGhpcy5hcHBFbC5xdWVyeVNlbGVjdG9yKCcuc291cmNlLWxpbmtzLWZvcm0nKTtcblx0XHR0aGlzLmZvcm0uYWRkRXZlbnRMaXN0ZW5lcignc3VibWl0JywgdGhpcy5fb25Tb3VyY2VMaW5rc0Zvcm1TdWJtaXQuYmluZCh0aGlzKSk7XG5cdH1cblxuXHRfY3JlYXRlQ2xhc3MoQXBwLCBbe1xuXHRcdGtleTogJ19vblNvdXJjZUxpbmtzRm9ybVN1Ym1pdCcsXG5cdFx0dmFsdWU6IGZ1bmN0aW9uIF9vblNvdXJjZUxpbmtzRm9ybVN1Ym1pdChlKSB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHR0aGlzLnVybE1hcCA9IHtcblx0XHRcdFx0dmlkZW9Vcmw6IHRoaXMuYXBwRWwucXVlcnlTZWxlY3RvcignI3ZpZGVvVXJsJykudmFsdWUsXG5cdFx0XHRcdHN1YnNVcmw6IHRoaXMuYXBwRWwucXVlcnlTZWxlY3RvcignI3N1YlVybCcpLnZhbHVlLFxuXHRcdFx0XHRhdWRpb1VybDogdGhpcy5hcHBFbC5xdWVyeVNlbGVjdG9yKCcjYXVkaW9VcmwnKS52YWx1ZVxuXHRcdFx0fTtcblx0XHRcdHRoaXMuYXBwRWwucXVlcnlTZWxlY3RvcignLmluaXRpYWwtcGFnZScpLmNsYXNzTGlzdC5hZGQoJ2luaXRpYWwtcGFnZV9oaWRkZW4nKTtcblx0XHRcdHRoaXMuYXBwRWwucXVlcnlTZWxlY3RvcignLnZpZGVvLXBhZ2UnKS5jbGFzc0xpc3QucmVtb3ZlKCd2aWRlby1wYWdlX2hpZGRlbicpO1xuXG5cdFx0XHR0aGlzLmNhbnZhcyA9IG5ldyBDYW52YXModGhpcy5hcHBFbC5xdWVyeVNlbGVjdG9yKCcuY2FudmFzJykpO1xuXHRcdFx0dGhpcy5zdWJzID0gbmV3IFN1YnModGhpcy51cmxNYXApO1xuXHRcdFx0dGhpcy5wbGF5ZXIgPSBuZXcgUGxheWVyKHRoaXMuYXBwRWwucXVlcnlTZWxlY3RvcignLnZpZGVvJyksIHRoaXMudXJsTWFwLCB0aGlzLmNhbnZhcywgdGhpcy5zdWJzKTtcblx0XHR9XG5cdH1dKTtcblxuXHRyZXR1cm4gQXBwO1xufSgpO1xuXG47XG5cbnZhciBQbGF5ZXIgPSBmdW5jdGlvbiAoKSB7XG5cdGZ1bmN0aW9uIFBsYXllcihlbCwgdXJsTWFwLCBjYW52YXMsIHN1YnMpIHtcblx0XHRfY2xhc3NDYWxsQ2hlY2sodGhpcywgUGxheWVyKTtcblxuXHRcdHRoaXMucGxheWVyRWwgPSBlbDtcblx0XHR0aGlzLnZpZGVvVXJsID0gdXJsTWFwLnZpZGVvVXJsO1xuXHRcdHRoaXMuc3Vic1VybCA9IHVybE1hcC5zdWJzVXJsO1xuXHRcdHRoaXMuY2FudmFzID0gY2FudmFzO1xuXHRcdHRoaXMuc3VicyA9IHN1YnM7XG5cdFx0dGhpcy5zdWJzQ3VyctChdWUgPSAwO1xuXHRcdHRoaXMudmlkZW9Tb3VyY2VFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NvdXJjZScpO1xuXHRcdHRoaXMudmlkZW9Tb3VyY2VFbC5zZXRBdHRyaWJ1dGUoJ3NyYycsIHRoaXMudmlkZW9VcmwpO1xuXHRcdHRoaXMucGxheWVyRWwuYXBwZW5kQ2hpbGQodGhpcy52aWRlb1NvdXJjZUVsKTtcblx0XHR0aGlzLnBsYXllckVsLmFkZEV2ZW50TGlzdGVuZXIoJ3BsYXknLCB0aGlzLl9vblZpZGVvU3RhcnRUb1BsYXkuYmluZCh0aGlzKSk7XG5cdFx0dGhpcy5wbGF5ZXJFbC5hZGRFdmVudExpc3RlbmVyKCdzZWVraW5nJywgdGhpcy5fb25WaWRlb1NlZWtpbmcuYmluZCh0aGlzKSk7XG5cdH1cblxuXHRfY3JlYXRlQ2xhc3MoUGxheWVyLCBbe1xuXHRcdGtleTogJ19vblZpZGVvU3RhcnRUb1BsYXknLFxuXHRcdHZhbHVlOiBmdW5jdGlvbiBfb25WaWRlb1N0YXJ0VG9QbGF5KGUpIHtcblx0XHRcdGlmICh0aGlzLmNoZWNrU3Vic0F2YWlsYWJpbGl0eShlKSA9PT0gZmFsc2UpIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fTtcblx0XHRcdHRoaXMuc2V0Q2FudmFzU2l6ZXNUb1ZpZGVvU2l6ZXMoKTtcblx0XHRcdHRoaXMuc3RhcnRUaW1l0KFvdW50dXAoKTtcblx0XHRcdHRoaXMud2F0Y2hUaGVWaWRlbygpO1xuXHRcdH1cblx0fSwge1xuXHRcdGtleTogJ19vblZpZGVvU2Vla2luZycsXG5cdFx0dmFsdWU6IGZ1bmN0aW9uIF9vblZpZGVvU2Vla2luZyhlKSB7XG5cdFx0XHRmaWx0ZXJQYXJzZWRTdWJzKCk7XG5cdFx0fVxuXHR9LCB7XG5cdFx0a2V5OiAnY2hlY2tTdWJzQXZhaWxhYmlsaXR5Jyxcblx0XHR2YWx1ZTogZnVuY3Rpb24gY2hlY2tTdWJzQXZhaWxhYmlsaXR5KGUpIHtcblx0XHRcdGlmICghdGhpcy5zdWJzLnJlYWR5KSB7XG5cdFx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0dGhpcy5wbGF5ZXJFbC5wYXVzZSgpO1xuXHRcdFx0XHR0aGlzLnBsYXllckVsLmN1cnJlbnRUaW1lID0gMDtcblx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdFx0fTtcblx0XHR9XG5cdH0sIHtcblx0XHRrZXk6ICdzZXRDYW52YXNTaXplc1RvVmlkZW9TaXplcycsXG5cdFx0dmFsdWU6IGZ1bmN0aW9uIHNldENhbnZhc1NpemVzVG9WaWRlb1NpemVzKCkge1xuXHRcdFx0dGhpcy52aWRlb1dpZHRoID0gdGhpcy5wbGF5ZXJFbC5jbGllbnRXaWR0aDtcblx0XHRcdHRoaXMudmlkZW9IZWlnaHQgPSB0aGlzLnBsYXllckVsLmNsaWVudEhlaWdodDtcblx0XHRcdHRoaXMuY2FudmFzLmNhbnZhc0VsLndpZHRoID0gdGhpcy52aWRlb1dpZHRoO1xuXHRcdFx0dGhpcy5jYW52YXMuY2FudmFzRWwuaGVpZ2h0ID0gdGhpcy52aWRlb0hlaWdodDtcblx0XHR9XG5cdH0sIHtcblx0XHRrZXk6ICdnZXROZWVkZWRTdWJzRm9yVGhpc1RpbWUnLFxuXHRcdHZhbHVlOiBmdW5jdGlvbiBnZXROZWVkZWRTdWJzRm9yVGhpc1RpbWUoKSB7XG5cdFx0XHR2YXIgY3VycmVudFRpbWUgPSBwYXJzZUludCh0aGlzLnBsYXllckVsLmN1cnJlbnRUaW1lICogMTAwMCk7XG5cdFx0XHR2YXIgZmlsdGVyZWRTdWJzID0gdGhpcy5zdWJzLnBhcnNlZFN1YnMuZmlsdGVyKGZ1bmN0aW9uIChpdGVtKSB7XG5cdFx0XHRcdGlmIChpdGVtLmVuZFRpbWUgPj0gY3VycmVudFRpbWUpIHtcblx0XHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdFx0fTtcblx0XHRcdH0pO1xuXHRcdFx0cmV0dXJuIGZpbHRlcmVkU3Vicztcblx0XHR9XG5cdH0sIHtcblx0XHRrZXk6ICdmaWx0ZXJQYXJzZWRTdWJzJyxcblx0XHR2YWx1ZTogZnVuY3Rpb24gZmlsdGVyUGFyc2VkU3VicygpIHtcblx0XHRcdHZhciBfdGhpcyA9IHRoaXM7XG5cblx0XHRcdGlmICh0bykge1xuXHRcdFx0XHRjbGVhclRpbWVvdXQodG8pO1xuXHRcdFx0fTtcblx0XHRcdHZhciB0byA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRfdGhpcy5zdWJzLnBhcnNlZFN1YnMgPSBfdGhpcy5nZXROZWVkZWRTdWJzRm9yVGhpc1RpbWUoKTtcblx0XHRcdH0sIDEwKTtcblx0XHR9XG5cdH0sIHtcblx0XHRrZXk6ICdzdGFydFRpbWXQoW91bnR1cCcsXG5cdFx0dmFsdWU6IGZ1bmN0aW9uIHN0YXJ0VGltZU91bnR1cCgpIHtcblx0XHRcdHZhciBfdGhpczIgPSB0aGlzO1xuXG5cdFx0XHR2YXIgbWFyZ2luVG9TdGFydE9mU3VicyA9IHRoaXMuc3Vicy5wYXJzZWRTdWJzW3RoaXMuc3Vic0N1cnLQoXVlXS5lbmRUaW1lIC0gcGFyc2VJbnQodGhpcy5wbGF5ZXJFbC5jdXJyZW50VGltZSk7XG5cdFx0XHR2YXIgbmVhcmVzdFBhdXNlRHVyYXRpb24gPSB0aGlzLnN1YnMucGFyc2VkU3Vic1t0aGlzLnN1YnNDdXJy0KF1ZV0uZW5kVGltZSAtIHRoaXMuc3Vicy5wYXJzZWRTdWJzW3RoaXMuc3Vic0N1cnLQoXVlXS5zdGFydFRpbWU7XG5cblx0XHRcdGNvbnNvbGUubG9nKG1hcmdpblRvU3RhcnRPZlN1YnMsIG5lYXJlc3RQYXVzZUR1cmF0aW9uKTtcblxuXHRcdFx0dmFyIHQxID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdF90aGlzMi5wbGF5ZXJFbC5wYXVzZSgpO1xuXHRcdFx0XHRjbGVhclRpbWVvdXQodDEpO1xuXHRcdFx0XHR2YXIgdDIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHRfdGhpczIucGxheWVyRWwucGxheSgpO1xuXHRcdFx0XHRcdF90aGlzMi5zdWJzQ3VyctChdWUrKztcblx0XHRcdFx0XHRtYXJnaW5Ub1N0YXJ0T2ZTdWJzID0gX3RoaXMyLnN1YnMucGFyc2VkU3Vic1tfdGhpczIuc3Vic0N1cnLQoXVlXS5lbmRUaW1lIC0gcGFyc2VJbnQoX3RoaXMyLnBsYXllckVsLmN1cnJlbnRUaW1lKTtcblx0XHRcdFx0XHRuZWFyZXN0UGF1c2VEdXJhdGlvbiA9IF90aGlzMi5zdWJzLnBhcnNlZFN1YnNbX3RoaXMyLnN1YnNDdXJy0KF1ZV0uZW5kVGltZSAtIF90aGlzMi5zdWJzLnBhcnNlZFN1YnNbX3RoaXMyLnN1YnNDdXJy0KF1ZV0uc3RhcnRUaW1lO1xuXHRcdFx0XHRcdGNsZWFyVGltZW91dCh0Mik7XG5cdFx0XHRcdH0sIG5lYXJlc3RQYXVzZUR1cmF0aW9uKTtcblx0XHRcdH0sIG1hcmdpblRvU3RhcnRPZlN1YnMpO1xuXHRcdH1cblx0fSwge1xuXHRcdGtleTogJ3dhdGNoVGhlVmlkZW8nLFxuXHRcdHZhbHVlOiBmdW5jdGlvbiB3YXRjaFRoZVZpZGVvKCkge1xuXHRcdFx0dmFyIF90aGlzMyA9IHRoaXM7XG5cblx0XHRcdGlmICh0aGlzLnBsYXllckVsLnBhdXNlZCB8fCB0aGlzLnBsYXllckVsLmVuZGVkKSB7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH07XG5cblx0XHRcdHRoaXMucGFpbnRGcmFtZSgpO1xuXG5cdFx0XHRzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0X3RoaXMzLndhdGNoVGhlVmlkZW8oKTtcblx0XHRcdH0sIDApO1xuXHRcdH1cblx0fSwge1xuXHRcdGtleTogJ3BhaW50RnJhbWUnLFxuXHRcdHZhbHVlOiBmdW5jdGlvbiBwYWludEZyYW1lKCkge1xuXHRcdFx0dGhpcy5jYW52YXMuY29udGV4dC5kcmF3SW1hZ2UodGhpcy5wbGF5ZXJFbCwgMCwgMCwgdGhpcy52aWRlb1dpZHRoLCB0aGlzLnZpZGVvSGVpZ2h0KTtcblx0XHRcdHZhciBmcmFtZSA9IHRoaXMuY2FudmFzLmNvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIHRoaXMudmlkZW9XaWR0aCwgdGhpcy52aWRlb0hlaWdodCk7XG5cdFx0XHR2YXIgbGVuZ3RoID0gZnJhbWUuZGF0YS5sZW5ndGggLyA0O1xuXG5cdFx0XHRmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG5cdFx0XHRcdHZhciByID0gZnJhbWUuZGF0YVtpICogNCArIDBdO1xuXHRcdFx0XHR2YXIgZyA9IGZyYW1lLmRhdGFbaSAqIDQgKyAxXTtcblx0XHRcdFx0dmFyIGIgPSBmcmFtZS5kYXRhW2kgKiA0ICsgMl07XG5cdFx0XHRcdHZhciBhdmVyYWdlID0gMC4yMSAqIHIgKyAwLjcyICogZyArIDAuMDcgKiBiO1xuXHRcdFx0XHRmcmFtZS5kYXRhW2kgKiA0ICsgMF0gPSBhdmVyYWdlO1xuXHRcdFx0XHRmcmFtZS5kYXRhW2kgKiA0ICsgMV0gPSBhdmVyYWdlO1xuXHRcdFx0XHRmcmFtZS5kYXRhW2kgKiA0ICsgMl0gPSBhdmVyYWdlO1xuXHRcdFx0fTtcblxuXHRcdFx0dGhpcy5jYW52YXMuY29udGV4dC5wdXRJbWFnZURhdGEoZnJhbWUsIDAsIDApO1xuXHRcdH1cblx0fV0pO1xuXG5cdHJldHVybiBQbGF5ZXI7XG59KCk7XG5cbjtcblxudmFyIENhbnZhcyA9IGZ1bmN0aW9uIENhbnZhcyhlbCkge1xuXHRfY2xhc3NDYWxsQ2hlY2sodGhpcywgQ2FudmFzKTtcblxuXHR0aGlzLmNhbnZhc0VsID0gZWw7XG5cdHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzRWwuZ2V0Q29udGV4dChcIjJkXCIpO1xufTtcblxuO1xuXG52YXIgU3VicyA9IGZ1bmN0aW9uICgpIHtcblx0ZnVuY3Rpb24gU3Vicyh1cmxNYXApIHtcblx0XHR2YXIgX3RoaXM0ID0gdGhpcztcblxuXHRcdF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTdWJzKTtcblxuXHRcdHRoaXMucmVhZHkgPSBmYWxzZTtcblx0XHRmZXRjaCh1cmxNYXAuc3Vic1VybCkudGhlbihmdW5jdGlvbiAocmVzKSB7XG5cdFx0XHRyZXMudGV4dCgpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcblx0XHRcdFx0X3RoaXM0LnBhcnNlZFN1YnMgPSBfdGhpczQucGFyc2VGcm9tU3J0KGRhdGEpO1xuXHRcdFx0XHRfdGhpczQucmVhZHkgPSB0cnVlO1xuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdH1cblxuXHRfY3JlYXRlQ2xhc3MoU3VicywgW3tcblx0XHRrZXk6ICdwYXJzZUZyb21TcnQnLFxuXHRcdHZhbHVlOiBmdW5jdGlvbiBwYXJzZUZyb21TcnQoc3J0KSB7XG5cdFx0XHR2YXIgcGFyc2VkU3VicyA9IHBhcnNlci5mcm9tU3J0KHNydCk7XG5cblx0XHRcdHBhcnNlZFN1YnMubWFwKGZ1bmN0aW9uIChpdGVtKSB7XG5cdFx0XHRcdHRpbWVQYXJzZVRvTXMoJ2VuZFRpbWUnLCBpdGVtKTtcblx0XHRcdFx0dGltZVBhcnNlVG9Ncygnc3RhcnRUaW1lJywgaXRlbSk7XG5cdFx0XHR9KTtcblxuXHRcdFx0ZnVuY3Rpb24gdGltZVBhcnNlVG9Ncyh0aW1lVHlwZSwgaXRlbSkge1xuXHRcdFx0XHR2YXIgc3Vic1N0YXJ0VGltZUJ1ZmZlciA9IGl0ZW1bdGltZVR5cGVdLnNwbGl0KCc6Jyk7XG5cdFx0XHRcdHZhciBob3VycyA9IHN1YnNTdGFydFRpbWVCdWZmZXJbMF07XG5cdFx0XHRcdHZhciBtaW5zID0gTnVtYmVyKHN1YnNTdGFydFRpbWVCdWZmZXJbMV0pO1xuXHRcdFx0XHR2YXIgc2Vjc0FuZE1zZWNzQnVmZmVyID0gc3Vic1N0YXJ0VGltZUJ1ZmZlclsyXS5zcGxpdCgnLCcpO1xuXHRcdFx0XHR2YXIgc2VjcyA9IE51bWJlcihzZWNzQW5kTXNlY3NCdWZmZXJbMF0pO1xuXHRcdFx0XHR2YXIgbXNlY3MgPSBOdW1iZXIoc2Vjc0FuZE1zZWNzQnVmZmVyWzFdKTtcblx0XHRcdFx0aXRlbVt0aW1lVHlwZV0gPSBob3VycyAqIDM2MDAwMDAgKyBtaW5zICogNjAwMDAgKyBzZWNzICogMTAwMCArIG1zZWNzO1xuXHRcdFx0fTtcblx0XHRcdHJldHVybiBwYXJzZWRTdWJzO1xuXHRcdH1cblx0fV0pO1xuXG5cdHJldHVybiBTdWJzO1xufSgpO1xuXG47XG5cbnZhciBhcHAgPSBuZXcgQXBwKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5hcHAnKSk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
